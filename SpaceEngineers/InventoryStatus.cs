using Sandbox.Game.EntityComponents;
using Sandbox.ModAPI.Ingame;
using Sandbox.ModAPI.Interfaces;
using SpaceEngineers.Game.ModAPI.Ingame;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Collections.Immutable;
using System.Linq;
using System.Text;
using VRage;
using VRage.Collections;
using VRage.Game;
using VRage.Game.Components;
using VRage.Game.GUI.TextPanel;
using VRage.Game.ModAPI.Ingame;
using VRage.Game.ModAPI.Ingame.Utilities;
using VRage.Game.ObjectBuilders.Definitions;
using VRageMath;

namespace IngameScript
{
    partial class Program : MyGridProgram
    {

        public Program()
        {
            Runtime.UpdateFrequency = UpdateFrequency.Update10;
        }

        public void Main(string argument, UpdateType updateSource)
        {
            IMyCockpit cockpit = GridTerminalSystem.GetBlockWithName("BumbleCat: Cockpit") as IMyCockpit;

            double dTotalVolume = 0;
            double dTotalMaxVolume = 0;

            var aCargoList = new List<IMyTerminalBlock>();
            GridTerminalSystem.GetBlocksOfType<IMyTerminalBlock>(aCargoList);

            foreach (IMyTerminalBlock oCargoContainer in aCargoList)
            {
                IMyEntity oCargoContainerEntity = oCargoContainer as IMyEntity;

                if (!oCargoContainerEntity.HasInventory)
                    continue;

                if (Me.CubeGrid != oCargoContainer.CubeGrid)
                    continue;

                try
                {
                    string park = oCargoContainer.GetActionWithName("Park").ToString();
                    continue;
                }
                catch
                {

                }

                IMyInventory oCurrentInventory = oCargoContainerEntity.GetInventory();
                dTotalVolume += (double)oCurrentInventory.CurrentVolume.RawValue;
                dTotalMaxVolume += (double)oCurrentInventory.MaxVolume.RawValue;
            }

            double dVolumePercentage = dTotalVolume / dTotalMaxVolume * 100.0;

            IMyReflectorLight oSpotlight = GridTerminalSystem.GetBlockWithName("BumbleCat: Spotlight") as IMyReflectorLight;

            IMyTextPanel oScreen = PreparePanel(cockpit);
            oSpotlight.Color = new Color(255, 255, 255);
            oScreen.WriteText(Math.Round(dVolumePercentage, 1).ToString());
            cockpit.GetSurface(0).WriteText(Math.Round(dVolumePercentage, 1).ToString());

            if (dVolumePercentage > (double)95) //if full
            {
                oScreen.FontColor = new Color(255, 0, 0);
                cockpit.GetSurface(0).FontColor = new Color(255, 0, 0);

                oSpotlight.Color = new Color(255, 0, 0);
            }
            else if (dVolumePercentage > (double)75)
            {
                cockpit.GetSurface(0).FontColor = new Color(200, 150, 0);
                oScreen.FontColor = new Color(200, 150, 0);
            }
            else if (dVolumePercentage > (double)50)
            {
                cockpit.GetSurface(0).FontColor = new Color(232, 179, 35);
                oScreen.FontColor = new Color(232, 179, 35);
            }
            else if (dVolumePercentage > (double)0)
            {
                cockpit.GetSurface(0).FontColor = new Color(0, 200, 0);
                oScreen.FontColor = new Color(0, 200, 0);
            }

            else // if empty
            {
                oScreen = PrepareLogo(cockpit);
                cockpit.GetSurface(0).WriteText(getCatLogo());
                oScreen.WriteText(getCatLogo());

                oSpotlight.Color = new Color(255, 255, 255);
            }
        }

        void Log(string sMessage)
        {
            IMyTextPanel oScreen = PreparePanel();

            List<string> aOldText = oScreen.GetText().Split('\n').ToList();

            if (aOldText.Count >= 17)
                aOldText.RemoveAt(0);

            string sNewText = String.Join(Environment.NewLine, aOldText.ToArray()) + Environment.NewLine + DateTime.Now.ToString("H:mm:ss") + ": " + sMessage;
            oScreen.WriteText(sNewText);
        }

        void Log(IMyTerminalBlock aMessage)
        {
            IMyTextPanel oScreen = PreparePanel();

            //Get Actions
            List<ITerminalAction> aActions = new List<ITerminalAction>();
            aMessage.GetActions(aActions);

            string sActions = "Actions: " + Environment.NewLine;

            for (int i = 0; i < aActions.Count; i++)
                sActions += aActions[i].Name + Environment.NewLine;

            //Get Properties
            List<ITerminalProperty> aProperties = new List<ITerminalProperty>();
            aMessage.GetProperties(aProperties);

            string sProperties = "Properties: " + Environment.NewLine;

            for (int i = 0; i < aProperties.Count; i++)
                sProperties += aProperties[i].Id + Environment.NewLine;

            oScreen.WriteText(sActions + Environment.NewLine + sProperties);
        }

        IMyTextPanel PreparePanel(IMyCockpit cockpit = null)
        {
            IMyTextPanel oScreen = GridTerminalSystem.GetBlockWithName("BumbleCat: Cat Logo") as IMyTextPanel;
            if (cockpit != null)
            {
                cockpit.GetSurface(0).ContentType = ContentType.TEXT_AND_IMAGE;
                // Blue bg color = 0, 136, 190
                cockpit.GetSurface(0).FontColor = new Color(255, 255, 255);
                cockpit.GetSurface(0).Font = "Monospace";
                cockpit.GetSurface(0).FontSize = (float)6;
                cockpit.GetSurface(0).Alignment = TextAlignment.LEFT;
                cockpit.GetSurface(0).TextPadding = 0;
            }
            oScreen.SetValue<Int64>("Content", 1);
            // Blue bg color = 0, 136, 190
            oScreen.FontColor = new Color(232, 179, 35);
            oScreen.Font = "Monospace";
            oScreen.FontSize = (float)6;
            oScreen.Alignment = TextAlignment.CENTER;
            oScreen.TextPadding = 26;

            return oScreen;
        }

        IMyTextPanel PrepareLogo(IMyCockpit cockpit)
        {
            IMyTextPanel oScreen = GridTerminalSystem.GetBlockWithName("BumbleCat: Cat Logo") as IMyTextPanel;

            cockpit.GetSurface(0).ContentType = ContentType.TEXT_AND_IMAGE;
            // Blue bg color = 0, 136, 190
            cockpit.GetSurface(0).FontColor = new Color(255, 255, 255);
            cockpit.GetSurface(0).Font = "Monospace";
            cockpit.GetSurface(0).FontSize = (float)0.1;
            cockpit.GetSurface(0).Alignment = TextAlignment.LEFT;
            cockpit.GetSurface(0).TextPadding = 0;

            oScreen.SetValue<Int64>("Content", 1);
            // Blue bg color = 0, 136, 190
            oScreen.FontColor = new Color(255, 255, 255);
            oScreen.Font = "Monospace";
            oScreen.FontSize = (float)0.1;
            oScreen.Alignment = TextAlignment.LEFT;
            oScreen.TextPadding = 0;

            return oScreen;
        }

        public string getCatLogo()
        {
            string sCatLogo = "";
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            sCatLogo += "" + Environment.NewLine;
            return sCatLogo;
        }
    }
}